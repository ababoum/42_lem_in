Protect mallocs
Solve memory leaks